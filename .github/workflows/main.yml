name: Ubuntu VNC

on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Install Desktop Environment & VNC
        run: |
          sudo apt update
          sudo apt install xfce4 xfce4-goodies tightvncserver git curl expect -y
          
          # create vnc password non-interactively
          mkdir -p ~/.vnc
          echo "#!/usr/bin/expect
          spawn vncpasswd
          expect \"Password:\"
          send \"123456\n\"
          expect \"Verify:\"
          send \"123456\n\"
          expect \"Would you like to enter a view-only password (y/n)?\"
          send \"n\n\"
          expect eof" > vncpassgen.exp
          chmod +x vncpassgen.exp
          ./vncpassgen.exp
          
          vncserver :1
          vncserver -kill :1

          echo "#!/bin/bash
          xrdb $HOME/.Xresources
          startxfce4 &" > ~/.vnc/xstartup
          chmod +x ~/.vnc/xstartup
          vncserver :1 -geometry 1280x720 -depth 24

      - name: Setup noVNC + websockify
        run: |
          git clone https://github.com/novnc/noVNC.git ~/noVNC
          git clone https://github.com/novnc/websockify ~/websockify
          nohup ~/websockify/run 6080 localhost:5901 &

      - name: Setup Cloudflare Tunnel
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          nohup ./cloudflared tunnel --url http://localhost:6080 --no-autoupdate &
          sleep 10
          echo "‚úÖ VNC is running!"
          echo "üîë Password = 123456"
          echo "üåç Check the Cloudflare logs below for your public HTTPS link."
